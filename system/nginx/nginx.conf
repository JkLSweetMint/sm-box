user  nginx;
worker_processes  auto;
worker_cpu_affinity auto;
worker_rlimit_nofile 10000;
pcre_jit on;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;

load_module /usr/lib/nginx/modules/ngx_http_js_module.so;

events {
    multi_accept on;
    accept_mutex off;
    worker_connections 1024;
}

http {
    js_path "/etc/nginx/njs/";
    js_import main from auth.js;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    open_file_cache max=200000 inactive=20s;
    open_file_cache_valid 120s;
    open_file_cache_errors on;
    reset_timedout_connection on;
    client_body_timeout 10;
    keepalive_timeout 65;
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=all:15m inactive=30m max_size=1G;

    map $request_uri $request_uri_path {
        "~^(?P<path>[^?]*)(\?.*)?$" $path;
    }

    server {
        server_name box.samgk.ru;

        listen       80;
        listen  [::]:80;

        return https://$http_host$request_uri;
    }

    server {
        server_name box.samgk.ru;

        root /var/www/dashboard;
        index index.html;

    	ssl_certificate "/etc/nginx/cert/samgk.ru.crtca";
    	ssl_certificate_key "/etc/nginx/cert/samgk.ru.key";
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;

        charset off;
        proxy_buffering off;

        gzip on;
        gzip_comp_level 5;
        gzip_disable "msie6";
        gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript image/svg+xml;

        location = /internal-auth {
            internal;
            proxy_pass http://authentication-service:8080/authentication/api/v1.0/nginx/auth;
            proxy_pass_request_body  off;

            proxy_set_header Content-Length "";
            proxy_set_header Upgrade $http_upgrade;

            include /etc/nginx/blocks/proxy_base.conf;
        }

        location @error401 {
           return 302 $scheme://box.samgk.ru/auth;
        }

        location @error403 {
           return 302 $scheme://box.samgk.ru/errors/403;
        }

        location @error50x {
           return 302 $scheme://box.samgk.ru/errors/50x;
        }

        location @error401_rest_api {
           default_type application/json;
           return 401 '
    {
       "code": 401,
       "code_message": "Unauthorized",
       "status": "failed",
       "error": {
           "id": "E-000004",
           "type": "system",
           "status": "error",
           "message": "Not authorized. ",
           "details": {}
       }
    }
           ';
        }

        location @error403_rest_api {
           default_type application/json;
           return 403 '
    {
       "code": 403,
       "code_message": "Forbidden",
       "status": "failed",
       "error": {
           "id": "E-000005",
           "type": "system",
           "status": "error",
           "message": "Not access. ",
           "details": {}
       }
    }
           ';
        }

        location @error500_rest_api {
           default_type application/json;
           return 500 '
    {
       "code": 500,
       "code_message": "Internal Server Error",
       "status": "error",
       "error": {
           "id": "I-000001",
           "type": "system",
           "status": "error",
           "message": "Internal server error. ",
           "details": {}
       }
    }
           ';
        }

        location @error502_rest_api {
           default_type application/json;
           return 502 '
    {
       "code": 502,
       "code_message": "Bad Gateway",
       "status": "error",
       "error": {
           "id": "I-000002",
           "type": "system",
           "status": "error",
           "message": "Bad Gateway. ",
           "details": {}
       }
    }
           ';
        }

        location @error503_rest_api {
           default_type application/json;
           return 503 '
    {
       "code": 503,
       "code_message": "Service Unavailable",
       "status": "error",
       "error": {
           "id": "I-000003",
           "type": "system",
           "status": "error",
           "message": "Service unavailable. ",
           "details": {}
       }
    }
           ';
        }

        location @error504_rest_api {
           default_type application/json;
           return 504 '
    {
       "code": 504,
       "code_message": "Gateway Timeout",
       "status": "error",
       "error": {
           "id": "I-000004",
           "type": "system",
           "status": "error",
           "message": "Gateway timeout. ",
           "details": {}
       }
    }
           ';
        }

        location / {
            include /etc/nginx/blocks/auth.conf;
            include /etc/nginx/blocks/cache.conf;

            add_header X-Authorization-State $auth_state_header;

            error_page 401 @error401;
            error_page 403 @error403;
            error_page 500 502 503 504 @error50x;

            rewrite /(.*) /$1  break;
#             proxy_pass    http://192.168.0.14:5173;
            proxy_pass    http://dashboard:5173;

            include /etc/nginx/blocks/proxy_base.conf;
        }

        include /etc/nginx/proxy/*.conf;

        listen       443 ssl;
        listen  [::]:443 ssl;
    }
}
